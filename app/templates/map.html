{% extends "layouts/base.html" %}

{% block title %}Carte Interactive - FoncierMap{% endblock %}

{% block content %}
<div class="h-full">
    <!-- Map Controls -->
    <div class="absolute top-4 left-4 z-10 bg-white rounded-lg shadow-md p-4 max-w-xs">
        <h3 class="font-semibold text-gray-900 mb-3">Filtres de carte</h3>
        
        <!-- Search -->
        <div class="mb-3">
            <input type="text" id="parcel-search" placeholder="Rechercher une parcelle..." 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        
        <!-- Status Filter -->
        <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Statut</label>
            <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="">Tous</option>
                <option value="Enregistré">Enregistré</option>
                <option value="En cours">En cours</option>
                <option value="Vendu">Vendu</option>
                <option value="Litigieux">Litigieux</option>
            </select>
        </div>
        
        <!-- Type Filter -->
        <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="">Tous</option>
                <option value="Résidentiel">Résidentiel</option>
                <option value="Commercial">Commercial</option>
                <option value="Agricole">Agricole</option>
                <option value="Industriel">Industriel</option>
            </select>
        </div>
        
        <!-- Map Layers -->
        <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-2">Couches</label>
            <div class="space-y-2">
                <label class="flex items-center">
                    <input type="checkbox" id="parcels-layer" checked class="mr-2">
                    <span class="text-sm">Parcelles</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="boundaries-layer" class="mr-2">
                    <span class="text-sm">Frontières</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="roads-layer" class="mr-2">
                    <span class="text-sm">Routes</span>
                </label>
            </div>
        </div>
        
        <button id="clear-filters" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-md text-sm transition-colors">
            Effacer les filtres
        </button>
    </div>
    
    <!-- Map Container -->
    <div id="main-map" class="w-full h-screen"></div>
    
    <!-- Legend -->
    <div class="absolute bottom-4 left-4 z-10 bg-white rounded-lg shadow-md p-4">
        <h4 class="font-medium text-gray-900 mb-2">Légende</h4>
        <div class="space-y-1 text-sm">
            <div class="flex items-center">
                <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                <span>Enregistré</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
                <span>En cours</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
                <span>Vendu</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                <span>Litigieux</span>
            </div>
        </div>
    </div>
    
    <!-- Parcel Info Panel -->
    <div id="parcel-info" class="hidden absolute top-4 right-4 z-10 bg-white rounded-lg shadow-md p-4 max-w-sm">
        <button id="close-info" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
        </button>
        <div id="parcel-details">
            <!-- Parcel information will be loaded here -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    const map = L.map('main-map').setView([6.5, 2.6], 8); // Center on Benin
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    let parcelsLayer = L.layerGroup().addTo(map);
    let allParcels = [];
    
    // Load parcels data
    fetch('/api/parcels')
        .then(response => response.json())
        .then(data => {
            allParcels = data;
            displayParcels(allParcels);
        })
        .catch(error => {
            console.error('Erreur lors du chargement des parcelles:', error);
        });
    
    function displayParcels(parcels) {
        parcelsLayer.clearLayers();
        
        parcels.forEach(parcel => {
            const color = getParcelColor(parcel.status);
            
            // Create marker
            const marker = L.circleMarker([parcel.latitude, parcel.longitude], {
                radius: 8,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            // Bind popup
            marker.bindPopup(`
                <div class="p-2">
                    <h5 class="font-semibold">${parcel.reference_number}</h5>
                    <p class="text-sm text-gray-600">${parcel.location}</p>
                    <p class="text-sm"><strong>Superficie:</strong> ${parcel.area} m²</p>
                    <p class="text-sm"><strong>Statut:</strong> ${parcel.status}</p>
                    <p class="text-sm"><strong>Type:</strong> ${parcel.parcel_type}</p>
                    <div class="mt-2">
                        <a href="/parcel/${parcel.id}" class="btn-primary text-white px-3 py-1 rounded text-sm">
                            Voir détails
                        </a>
                    </div>
                </div>
            `);
            
            // Add click event for info panel
            marker.on('click', function() {
                showParcelInfo(parcel);
            });
            
            parcelsLayer.addLayer(marker);
            
            // Add boundary if coordinates exist
            if (parcel.coordinates) {
                try {
                    const boundary = L.geoJSON(JSON.parse(parcel.coordinates), {
                        style: {
                            color: color,
                            weight: 2,
                            opacity: 0.8,
                            fillOpacity: 0.2
                        }
                    });
                    parcelsLayer.addLayer(boundary);
                } catch (e) {
                    console.log('Invalid coordinates for parcel:', parcel.reference_number);
                }
            }
        });
    }
    
    function getParcelColor(status) {
        switch (status) {
            case 'Enregistré': return '#10B981'; // green
            case 'En cours': return '#F59E0B'; // yellow  
            case 'Vendu': return '#3B82F6'; // blue
            case 'Litigieux': return '#EF4444'; // red
            default: return '#6B7280'; // gray
        }
    }
    
    function showParcelInfo(parcel) {
        const infoPanel = document.getElementById('parcel-info');
        const detailsDiv = document.getElementById('parcel-details');
        
        detailsDiv.innerHTML = `
            <h4 class="font-semibold text-lg mb-2">${parcel.reference_number}</h4>
            <div class="space-y-2 text-sm">
                <p><strong>Localisation:</strong> ${parcel.location}</p>
                <p><strong>Superficie:</strong> ${parcel.area} m²</p>
                <p><strong>Type:</strong> ${parcel.parcel_type}</p>
                <p><strong>Statut:</strong> 
                    <span class="px-2 py-1 rounded text-xs" style="background-color: ${getParcelColor(parcel.status)}20; color: ${getParcelColor(parcel.status)}">
                        ${parcel.status}
                    </span>
                </p>
                <p><strong>Propriétaire:</strong> ${parcel.owner_name}</p>
                ${parcel.description ? `<p><strong>Description:</strong> ${parcel.description}</p>` : ''}
            </div>
            <div class="mt-4 flex space-x-2">
                <a href="/parcel/${parcel.id}" class="btn-primary text-white px-3 py-2 rounded text-sm flex-1 text-center">
                    Voir détails
                </a>
                ${parcel.owner_id === {{ current_user.id if current_user.is_authenticated else 'null' }} ? 
                    '<button class="bg-gray-100 text-gray-700 px-3 py-2 rounded text-sm">Modifier</button>' : ''
                }
            </div>
        `;
        
        infoPanel.classList.remove('hidden');
    }
    
    // Filter functionality
    function applyFilters() {
        const searchTerm = document.getElementById('parcel-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        const typeFilter = document.getElementById('type-filter').value;
        
        const filteredParcels = allParcels.filter(parcel => {
            const matchesSearch = !searchTerm || 
                parcel.reference_number.toLowerCase().includes(searchTerm) ||
                parcel.location.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || parcel.status === statusFilter;
            const matchesType = !typeFilter || parcel.parcel_type === typeFilter;
            
            return matchesSearch && matchesStatus && matchesType;
        });
        
        displayParcels(filteredParcels);
    }
    
    // Event listeners
    document.getElementById('parcel-search').addEventListener('input', applyFilters);
    document.getElementById('status-filter').addEventListener('change', applyFilters);
    document.getElementById('type-filter').addEventListener('change', applyFilters);
    
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('parcel-search').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('type-filter').value = '';
        displayParcels(allParcels);
    });
    
    document.getElementById('close-info').addEventListener('click', function() {
        document.getElementById('parcel-info').classList.add('hidden');
    });
    
    // Layer controls
    document.getElementById('parcels-layer').addEventListener('change', function() {
        if (this.checked) {
            map.addLayer(parcelsLayer);
        } else {
            map.removeLayer(parcelsLayer);
        }
    });
});
</script>
{% endblock %}